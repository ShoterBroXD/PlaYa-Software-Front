<div class="categories-page">
  <div class="header">
    <div class="title-row">
      <h1 class="page-title">{{ genreName ? genreName : 'Pistas' }}</h1>
      <p class="subtitle">{{ genreName ? 'Canciones de ' + genreName : 'Califica tus canciones favoritas con estrellas
        &#9733;' }}</p>
    </div>
    <div class="filter-buttons">
      <a routerLink="/categories" class="filter-button">Todos</a>
      <a routerLink="/categories/tracks" class="filter-button active">Pistas</a>
      <a routerLink="/categories/playlists" class="filter-button">Listas</a>

    </div>
  </div>

  <div class="loading-container" *ngIf="isLoading">
    <p>Cargando canciones...</p>
  </div>

  <div class="error-container" *ngIf="error && !isLoading">
    <p>{{ error }}</p>
  </div>

  <div class="song-grid" *ngIf="!isLoading && songs.length">
    <div class="card-song" *ngFor="let song of songs" (click)="playSong(song)">
      <img [src]="song.coverURL || '/assets/img/images/img-placeholder.svg'" [alt]="song.title" class="card-img">
      <div class="card-info">
        <div class="info-top">
          <p class="song-title">{{ song.title }}</p>
          <div class="dropdown-menu">
            <button class="menu-btn" (click)="toggleDropdown($event, song.idSong)" title="Más opciones">
              <img src="/assets/img/icons/icon-three-dots.svg" alt="Menú" />
            </button>
            <div class="dropdown-content" [class.show]="isDropdownOpen(song.idSong)">
              <button class="dropdown-item" (click)="toggleLike(song.idSong); $event.stopPropagation()">
                <i class="fa-solid fa-heart"></i> Me gusta
              </button>
              <button class="dropdown-item" (click)="openAddToPlaylistModal(song.idSong); $event.stopPropagation()">
                <i class="fa-solid fa-list"></i> Añadir a playlist
              </button>
              <button class="dropdown-item" (click)="shareSong(song.idSong); $event.stopPropagation()">
                <i class="fa-solid fa-share"></i> Compartir
              </button>
              <button class="dropdown-item" (click)="openRatingModal(song.idSong); $event.stopPropagation()">
                <i class="fa-solid fa-star"></i> Ratear
              </button>
              <button class="dropdown-item report-btn" (click)="openReportModal(song.idSong); $event.stopPropagation()">
                <i class="fa-solid fa-flag"></i> Reportar
              </button>
            </div>
          </div>
        </div>
        <p class="song-details">{{ song.artist?.name || 'Artista' }} · {{ song.uploadDate ? (song.uploadDate | date: 'yyyy') : '2025' }}</p>
      </div>
    </div>
  </div>

  <div class="empty-state" *ngIf="!isLoading && !songs.length">
    <i class="fa-solid fa-music" style="font-size: 4rem; color: #ccc;"></i>
    <p>No hay canciones disponibles</p>
  </div>
</div>

<app-add-to-playlist-modal [isOpen]="isModalOpen" [songIds]="selectedSongIds" (closeModal)="closeModal()"
  (added)="onSongsAdded()"></app-add-to-playlist-modal>

<app-report-modal *ngIf="showReportModal() && selectedTrackId()" [contentType]="'SONG'" [contentId]="selectedTrackId()!"
  (close)="closeReportModal()" (submitted)="onReportSubmitted()"></app-report-modal>

<!-- Rating modal -->
<div class="modal-overlay" *ngIf="showRatingModal()" (click)="closeRatingModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Calificar canción</h3>
      <button class="close-btn" (click)="closeRatingModal()">&times;</button>
    </div>
    <div class="modal-body" *ngIf="selectedSong">
      <app-song-rating 
        [songId]="selectedSong.idSong" 
        [currentRating]="selectedSong.averageRating || 0"
        [ratingCount]="selectedSong.ratingCount || 0" 
        (ratingChanged)="onRatingChanged(selectedSong.idSong, $event)">
      </app-song-rating>
    </div>
  </div>
</div>

<!-- Share modal -->
<div class="share-modal-overlay" *ngIf="showShareModal" (click)="closeShareModal()">
  <div class="share-modal" (click)="$event.stopPropagation()">
    <h3 class="share-title">Compartir en</h3>
    <div class="share-options">
      <button class="share-option" (click)="shareOn('facebook')">
        <i class="fab fa-facebook"></i>
        <span>Facebook</span>
      </button>
      <button class="share-option" (click)="shareOn('twitter')">
        <i class="fab fa-twitter"></i>
        <span>Twitter</span>
      </button>
      <button class="share-option" (click)="shareOn('whatsapp')">
        <i class="fab fa-whatsapp"></i>
        <span>WhatsApp</span>
      </button>
      <button class="share-option" (click)="shareOn('telegram')">
        <i class="fab fa-telegram"></i>
        <span>Telegram</span>
      </button>
      <button class="share-option" (click)="shareOn('instagram')">
        <i class="fab fa-instagram"></i>
        <span>Instagram</span>
      </button>
    </div>
  </div>
</div>