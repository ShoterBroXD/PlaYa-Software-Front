<section class="upload-page">
  <div class="upload-hero" *ngIf="userType() === 'ARTIST'; else listenerNotice">
    <h1>Listo para subir tu musica?</h1>
    <p>Da clic en el boton de abajo para comenzar.</p>
    <button class="primary" (click)="openModal()">Subir musica</button>
  </div>

  <ng-template #listenerNotice>
    <div class="upload-hero listener">
      <h1>Activa tu perfil de artista para subir musica</h1>
      <p>
        Actualmente estas usando una cuenta de oyente. Para compartir tus canciones, actualiza a un
        perfil de artista desde tu configuracion o ponte en contacto con nuestro equipo.
      </p>
      <button class="primary" routerLink="/premium">Conocer planes</button>
    </div>
  </ng-template>
</section>

<ng-container *ngIf="userType() === 'ARTIST'">
  <div class="modal-backdrop" *ngIf="showModal">
    <div class="upload-modal">
      <button class="close-button" aria-label="Cerrar" (click)="closeModal()">×</button>

      <div class="modal-header">
        <div class="modal-title">
          <img src="/assets/img/images/logo-playa.png" alt="PlaYa" />
          <span>
            {{
              activeStep === 'upload'
                ? 'Sube tus archivos'
                : activeStep === 'details'
                ? 'Informacion de la cancion'
                : activeStep === 'privacy'
                ? 'Visibilidad y privacidad'
                : activeStep === 'summary'
                ? 'Resumen'
                : 'Procesando subida'
            }}
          </span>
        </div>
        <div class="step-indicator">
          <span [class.active]="activeStep === 'upload'">1</span>
          <span [class.active]="activeStep === 'details'">2</span>
          <span [class.active]="activeStep === 'privacy'">3</span>
          <span [class.active]="activeStep === 'summary'">4</span>
        </div>
      </div>

      <!-- Paso 1 -->
      <ng-container *ngIf="activeStep === 'upload'">
        <p class="modal-subtitle">Sube tus archivos de audio</p>
        <p class="modal-description">
          Para obtener la mejor calidad, utiliza WAV, FLAC, AIFF o ALAC. Tamaño maximo 6GB.
        </p>
        <div class="drop-zone">
          <div>
            <img src="/assets/img/icons/add-list.svg" alt="upload" />
            <p>Arrastra y suelta tus archivos de audio para empezar</p>
            <label class="primary ghost">
              Elegir archivos
              <input type="file" hidden (change)="handleFiles($event.target.files)" multiple />
            </label>
          </div>
        </div>
        <ul class="file-list" *ngIf="uploadedFiles.length">
          <li *ngFor="let file of uploadedFiles">{{ file.name }}</li>
        </ul>
        <p class="info-text" *ngIf="isAudioUploading">Subiendo archivo...</p>
        <p class="error-text" *ngIf="uploadError">{{ uploadError }}</p>
        <div class="modal-actions">
          <button class="secondary" (click)="closeModal()">Cancelar</button>
          <button class="primary" [disabled]="!audioUrl || isAudioUploading" (click)="nextStep()">
            Continuar
          </button>
        </div>
      </ng-container>

      <!-- Paso 2 -->
      <ng-container *ngIf="activeStep === 'details'">
        <div class="details-grid">
          <div class="form-fields">
            <label>
              Titulo
              <input type="text" [(ngModel)]="formState.title" placeholder="Titulo de la cancion" />
            </label>
            <div class="two-columns">
              <label>
                Artista
                <input type="text" [(ngModel)]="formState.artist" placeholder="Tu nombre artistico" />
              </label>
              <label>
                Album
                <input type="text" [(ngModel)]="formState.album" placeholder="Nombre del album" />
              </label>
            </div>
            <label>
              Descripcion
              <textarea
                rows="3"
                [(ngModel)]="formState.description"
                placeholder="Describe tu cancion"
              ></textarea>
            </label>
            <div class="two-columns">
              <label>
                Etiqueta
                <input type="text" [(ngModel)]="formState.tag" placeholder="Ej: #summer" />
              </label>
            <label>
              Genero
              <select [ngModel]="selectedGenreId" (ngModelChange)="onGenreChange($event)" [disabled]="isGenresLoading">
                <option [ngValue]="null" disabled>Selecciona un genero</option>
                <option *ngFor="let genre of genres" [ngValue]="genre.idGenre">
                  {{ genre.name }}
                </option>
              </select>
              <small *ngIf="isGenresLoading">Cargando...</small>
              <small class="error-text" *ngIf="genreError">{{ genreError }}</small>
            </label>
          </div>
            <div class="drop-zone cover">
              <p>Arrastra y suelta tu portada</p>
              <label class="primary ghost">
                Portada
                <input type="file" hidden accept="image/*" (change)="handleCover($event)" />
              </label>
            </div>
            <p class="info-text" *ngIf="isCoverUploading">Subiendo portada...</p>
            <p class="error-text" *ngIf="coverError">{{ coverError }}</p>
          </div>
          <div class="details-illustration">
            <img src="/assets/img/images/man-singing.png" alt="Ilustracion cantante" />
          </div>
        </div>
      <div class="modal-actions">
        <button class="secondary" (click)="prevStep()">Volver</button>
        <button class="primary" [disabled]="isCoverUploading" (click)="nextStep()">Siguiente</button>
      </div>
      </ng-container>

      <!-- Paso 3 -->
      <ng-container *ngIf="activeStep === 'privacy'">
        <div class="privacy-grid">
          <div class="privacy-settings">
            <label>
              Visibilidad
              <select [(ngModel)]="formState.visibility">
                <option>Publico</option>
                <option>Privado</option>
                <option>Solo seguidores</option>
              </select>
            </label>
            <label>
              Permitir comentarios
              <select [(ngModel)]="formState.comments">
                <option>Todos</option>
                <option>Solo seguidores</option>
                <option>Nadie</option>
              </select>
            </label>

            <div class="toggle-row">
              <label>
                <input type="checkbox" [(ngModel)]="formState.schedule" />
                Programar publicacion
              </label>
              <input
                type="datetime-local"
                [disabled]="!formState.schedule"
                [(ngModel)]="formState.scheduleDate"
              />
            </div>

            <div class="toggle-row">
              <label>
                <input type="checkbox" [(ngModel)]="formState.allowDownload" />
                Permitir descargas
              </label>
            </div>

            <div class="toggle-row">
              <label>
                <input type="checkbox" [(ngModel)]="formState.includeInLists" />
                Incluir en listas
              </label>
            </div>
          </div>
          <div class="details-illustration">
            <img src="/assets/img/images/dj-girl.png" alt="Ilustracion DJ" />
          </div>
        </div>
        <div class="modal-actions">
          <button class="secondary" (click)="prevStep()">Volver</button>
          <button class="primary" (click)="nextStep()">Siguiente</button>
        </div>
      </ng-container>

      <!-- Paso 4 -->
      <ng-container *ngIf="activeStep === 'summary'">
        <div class="summary-layout">
          <div class="summary-panel">
            <h3>Resumen</h3>
            <ul>
              <li><strong>Archivo:</strong> {{ summaryData.fileName }}</li>
              <li><strong>Duracion:</strong> {{ summaryData.duration }}</li>
              <li><strong>Titulo:</strong> {{ summaryData.title || 'Sin titulo' }}</li>
              <li><strong>Artista:</strong> {{ summaryData.artist || 'Sin definir' }}</li>
              <li><strong>Genero:</strong> {{ summaryData.genre }}</li>
            </ul>

            <h3>Programado</h3>
            <ul>
              <li><strong>Visibilidad:</strong> {{ formState.visibility }}</li>
              <li><strong>Comentarios:</strong> {{ formState.comments }}</li>
              <li><strong>Descargas:</strong> {{ formState.allowDownload ? 'ON' : 'OFF' }}</li>
              <li><strong>Listas:</strong> {{ formState.includeInLists ? 'ON' : 'OFF' }}</li>
            </ul>
          </div>
          <div class="summary-preview">
            <div class="cover-preview" [class.empty]="!coverPreview">
              <img *ngIf="coverPreview" [src]="coverPreview" alt="Cover preview" />
              <span *ngIf="!coverPreview">Previsualizacion de portada</span>
            </div>
            <div class="summary-actions">
              <button class="secondary" (click)="prevStep()">Editar informacion</button>
              <button class="primary" [disabled]="isSubmitting" (click)="nextStep()">Subir ahora</button>
            </div>
            <p class="error-text" *ngIf="submitError">{{ submitError }}</p>
          </div>
        </div>
      </ng-container>

      <!-- Paso 5 -->
      <ng-container *ngIf="activeStep === 'progress'">
        <div class="progress-panel">
          <p class="modal-subtitle">Procesando tu cancion</p>
          <div class="progress-bar">
            <div class="progress" style="width: 75%"></div>
          </div>
          <p>Listo. Tu cancion esta disponible.</p>
          <div class="modal-actions">
            <button class="secondary" (click)="closeModal(); resetWizard()">Ver cancion</button>
            <button class="primary" (click)="closeModal(); resetWizard()">Volver a biblioteca</button>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</ng-container>
